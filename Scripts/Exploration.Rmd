---
title: "Exploration"
output: html_document
---

```{r setup}
# Load packages
library(tidyverse)
library(ggplot2) 
library(readxl) 
library(lubridate)
library(broom)
library(viridis)
library(tsModel)

# Global options
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

```


This contains all code used to explore the datasets found in the `/CleanData` directory, which were previously generated in the `/Scripts/Cleaning.rmd` file. 

```{r import}
monthly <- read.csv("../CleanData/monthly.csv") 

monthly <- monthly %>% 
  mutate(month_year = ymd(month_year))

#looking at when the bill was implemented
monthly %>% 
  group_by(bill8) %>% 
  slice(1:3) #month 42

``` 

Next we are going to plot the forcing value (time) and the outcome (death count)
```{r}
#looking at range of dates 
range(monthly$time)

ggplot()+
  geom_polygon(aes(c(42,70,70,42),
                   c(Inf, Inf, -Inf, -Inf)),
               fill = "cyan", alpha = 0.2)+
  geom_line(data = monthly, aes(time, Deaths))+
  labs(x = "Month in study",
       y = "Number of deaths by assault")

```

We want to investigate the death rate before and after the ban was implemented. To start, we are just going to use a simple poisson model.

```{r poisson_ITS}
mod1 <- glm(Deaths ~ time , 
                      data = monthly, 
                       family = poisson(link = "log"))
summary(mod1) 

#introducing bill8
mod2 <- glm(
  Deaths ~ time + bill8,
  family = poisson(link = "log"),
  data = monthly
)

summary(mod2) 

#extracting coefficient terms 
mod2 %>% 
  tidy()

#getting estimate of relative rate for group after bill vs. before

mod2 %>%
  tidy(conf.int = TRUE, exponentiate = TRUE) %>%
  filter(term == "bill8TRUE") %>%
  select(estimate, conf.low, conf.high)

#how to plot the interrupted ts 

#saving augmented data from model
mod2_data <- augment(mod2, type.predict = "response") %>%
  mutate(
    observed = Deaths,
    fitted   = .fitted
  ) 
intervention_time <- min(monthly$time[monthly$bill8])

#ggplotting
ggplot(mod2_data, aes(x = time)) + 
  #post-bill shading
   geom_rect(
    aes(
      xmin = intervention_time,
      xmax = max(time),
      ymin = -Inf,
      ymax = Inf
    ),
    fill = "cyan",
    alpha = 0.2,
    inherit.aes = FALSE
  ) +
  #observed death counts
   geom_line(aes(y = observed), alpha = 0.7) + 
  #fit ITS line 
  geom_line(aes(y = fitted), color = "red", linewidth = 1) +

  labs(
    x = "Time (months)",
    y = "Monthly deaths",
    title = "Interrupted Time Series Analysis",
    subtitle = "Poisson model with level change after Bill 8"
  ) +
  theme_minimal()
  
```

Looking at that first poisson model, there is no significance between groups. We expected that, however, as the poisson isn't the most appropriate selection and our data has seasonality trends. We are now going to look into making this a nonlinear model. 

```{r seasonality}
#making month_year a date var 
monthly <- monthly %>%
  mutate(
    month_year = as.Date(month_year),
    month = month(month_year)
  ) 

#post-intervention slope term
intervention_time <- min(monthly$time[monthly$bill8])

monthly <- monthly %>%
  mutate(
    time_after = if_else(bill8, time - intervention_time + 1, 0)
  )

monthly %>% 
  group_by(time_after) %>% 
  slice(1:3) 


mod3 <- glm(
  Deaths ~ bill8 + time + time_after +
    harmonic(month, 2, 12),
  data = monthly,
  family = quasipoisson(link = "log")
)

#plotting with seasonality
plot_data <- augment(mod3, type.predict = "response") %>%
  mutate(
    observed = Deaths,
    fitted = .fitted
  )

ggplot(plot_data, aes(x = time)) +

  geom_rect(
    aes(
      xmin = intervention_time,
      xmax = max(time),
      ymin = -Inf,
      ymax = Inf
    ),
    fill = "cyan",
    alpha = 0.2,
    inherit.aes = FALSE
  ) +

  geom_line(aes(y = observed), alpha = 0.6) +
  geom_line(aes(y = fitted), color = "red", linewidth = 1) +

  labs(
    x = "Time (months)",
    y = "Monthly deaths",
    title = "Interrupted Time Series with Seasonality Adjustment",
    subtitle = "Quasi-Poisson model with harmonic terms"
  ) +
  theme_minimal()


``` 


This provides us some interesting trends, but what we are really interested is utilizing an interrupted-ARIMA model to identify the significance of our outliers. There are several studies that use this methodology, but we are primarily going to replicate the methods described in [Singh et al., 2025](https://link.springer.com/article/10.1007/s00127-025-02902-7), a study which analyzes suicide deaths among reproductive-aged women post-*Dobbs*. 

This study also uses data from the Multiple Cause of Death database, and stratifies data by men and women by two age groups: 15-25 and 25-49. The outcomes are the monthly count of suicides nationally for reproductive-aged women overall and for the two age subgroups. The series of monthly suicides among men (per age group) were used as a control variable. The exposure was the timing of the *Dobbs* decision in June 2022. 

To extend this methodology to our study, we can also use male deaths as a control. Since we are using just texas data, it is unlikely that we will have enough counts to populate data if we further stratify by age 15-24 and 25-49. However, we will also do a sensitivity analysis that compares our trends to those nationally. 


We want to explore all ages for females as a sensitivity analysis. 