---
title: "Exploration"
output: html_document
---

```{r setup}
# Load packages
library(tidyverse)
library(ggplot2) 
library(readxl) 
library(lubridate)
library(broom)
library(viridis)
library(tsModel)

# Global options
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

```


This contains all code used to explore the datasets found in the `/CleanData` directory, which were previously generated in the `/Scripts/Cleaning.rmd` file. 

```{r import}
monthly <- read.csv("../CleanData/monthly.csv")

#looking at when the bill was implemented
monthly %>% 
  group_by(bill8) %>% 
  slice(1:3) #month 44

``` 

Next we are going to plot the forcing value (time) and the outcome (death count)
```{r}
ggplot()+
  geom_polygon(aes(c(44,90,90,44),
                   c(Inf, Inf, -Inf, -Inf)),
               fill = "cyan", alpha = 0.2)+
  geom_line(data = monthly, aes(time, Deaths))+
  labs(x = "Month in study",
       y = "Number of deaths by assault")


ggplot(monthly, aes(month_year, Deaths))+
  geom_line()+
   geom_hline(yintercept = c("2021-08-01", "2021-08-01"),linetype = 2)
```

We want to investigate the death rate before and after the ban was implemented. To start, we are just going to use a simple poisson model.

```{r poisson_ITS}
mod1 <- glm(Deaths ~ time , 
                      data = monthly, 
                       family = poisson(link = "log"))
summary(mod1) 

#introducing bill8
mod2 <- glm(
  Deaths ~ time + bill8,
  family = poisson(link = "log"),
  data = monthly
)

summary(mod2) 

#extracting coefficient terms 
mod2 %>% 
  tidy()

#getting estimate of relative rate for group after bill vs. before

mod2 %>%
  tidy(conf.int = TRUE, exponentiate = TRUE) %>%
  filter(term == "bill8TRUE") %>%
  select(estimate, conf.low, conf.high)

#how to plot the interrupted ts 

#saving augmented data from model
mod2_data <- augment(mod2, type.predict = "response") %>%
  mutate(
    observed = Deaths,
    fitted   = .fitted
  ) 
intervention_time <- min(monthly$time[monthly$bill8])

#ggplotting
ggplot(mod2_data, aes(x = time)) + 
  #post-bill shading
   geom_rect(
    aes(
      xmin = intervention_time,
      xmax = max(time),
      ymin = -Inf,
      ymax = Inf
    ),
    fill = "cyan",
    alpha = 0.2,
    inherit.aes = FALSE
  ) +
  #observed death counts
   geom_line(aes(y = observed), alpha = 0.7) + 
  #fit ITS line 
  geom_line(aes(y = fitted), color = "red", linewidth = 1) +

  labs(
    x = "Time (months)",
    y = "Monthly deaths",
    title = "Interrupted Time Series Analysis",
    subtitle = "Poisson model with level change after Bill 8"
  ) +
  theme_minimal()
  
```

Looking at that first poisson model, there is no significance between groups. We expected that, however, as the poisson isn't the most appropriate selection and our data has seasonality trends. We are now going to look into making this a nonlinear model. 

```{r seasonality}
#making month_year a date var 
monthly <- monthly %>%
  mutate(
    month_year = as.Date(month_year),
    month = month(month_year)
  ) 

#post-intervention slope term
intervention_time <- min(monthly$time[monthly$bill8])

monthly <- monthly %>%
  mutate(
    time_after = if_else(bill8, time - intervention_time + 1, 0)
  )

monthly %>% 
  group_by(time_after) %>% 
  slice(1:3) 


mod3 <- glm(
  Deaths ~ bill8 + time + time_after +
    harmonic(month, 2, 12),
  data = monthly,
  family = quasipoisson(link = "log")
)

#plotting with seasonality
plot_data <- augment(mod3, type.predict = "response") %>%
  mutate(
    observed = Deaths,
    fitted = .fitted
  )

ggplot(plot_data, aes(x = time)) +

  geom_rect(
    aes(
      xmin = intervention_time,
      xmax = max(time),
      ymin = -Inf,
      ymax = Inf
    ),
    fill = "cyan",
    alpha = 0.2,
    inherit.aes = FALSE
  ) +

  geom_line(aes(y = observed), alpha = 0.6) +
  geom_line(aes(y = fitted), color = "red", linewidth = 1) +

  labs(
    x = "Time (months)",
    y = "Monthly deaths",
    title = "Interrupted Time Series with Seasonality Adjustment",
    subtitle = "Quasi-Poisson model with harmonic terms"
  ) +
  theme_minimal()


``` 


We want to explore all ages for females as a sensitivity analysis. 