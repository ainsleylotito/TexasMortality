---
title: "Cleaning"
output: html_document
---

```{r setup}
# Load packages
library(tidyverse)
library(ggplot2) 
library(readxl) 
library(lubridate)
library(broom)
library(viridis)

# Global options
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

#importing functions
source("functions.r")
``` 

# Female Monthly Assault Counts 

```{r import_female}
rawdata_female <- read_excel("../RawData/MonthlyAssaults.xlsx") 
monthly_f <- rawdata_female %>% 
  mutate(month_year = my(Month)) %>% 
   select(-Notes,-Population,-"Crude Rate", -Month, -"Month Code") 
head(monthly_f) 

#excluding NA/provisional data: No data starting on Aug 2025. Total provisional data starts at Jan 2024. 

monthly_f <- monthly_f %>% 
  filter(month_year < "2024-01-01")

#creating a binary indicator variable to say whether the bill was in effect 
 
monthly_f <- monthly_f %>% 
  mutate(bill8 = month_year > "2021-08-01") #all months after August

monthly_f %>% 
  slice(35:55)
               

``` 

We need to apply the same cleaning methodology, this time for Texas resident males in the same age group (15-44). 

# Male Monthly Assault Counts 

```{r import_male}
rawdata_male <- read_excel("../RawData/MaleMonthlyAssaults.xlsx") 
monthly_m <- rawdata_male %>% 
  mutate(month_year = my(Month)) %>% 
   select(-Notes,-Population,-"Crude Rate", -Month, -"Month Code") 
head(monthly_m) 

#excluding NA/provisional data: No data starting on Aug 2025. Total provisional data starts at Jan 2024. 

monthly_m <- monthly_m %>% 
  filter(month_year < "2024-01-01")

#creating a binary indicator variable to say whether the bill was in effect 
 
monthly_m <- monthly_m %>% 
  mutate(bill8 = month_year > "2021-08-01") #all months after August

monthly_m %>% 
  slice(35:55)
               

``` 
It should be noted we are missing death data for females for May 2019 (2019-05-01) and September 2019 (2019-09-01). We need to fill in this hole, so we will investigate filling this gap in the data by querying both genders and subtracting the deaths for males to reveal how many were among females.

```{r filling_in_data}
rawdata_both_genders <- read_excel("../RawData/2019_monthly_both_sexes.xlsx") 
both_genders_2019 <- rawdata_both_genders %>% 
  mutate(month_year = my(Month)) %>% 
   select(-Notes,-Population,-"Crude Rate", -Month, -"Month Code") 
head(both_genders_2019)  

#selecting the dates we need 

both_genders_2019 %>% 
  filter(month_year %in% c("2019-05-01", "2019-09-01")) 

#107 in may, 96 in sept 

monthly_m %>% 
  filter(month_year %in% c("2019-05-01", "2019-09-01"))  
#98 in may, 89 in sept 

#may: 107-98 = 9
#sept: 96-89 = 7

#dropping the problematic rows for females
monthly_f <- monthly_f %>%
  filter(
    !(month_year %in% as.Date(c("2019-05-01", "2019-09-01")))
  )

monthly_f <- monthly_f %>%
  bind_rows(
    tibble(
      month_year = as.Date(c("2019-05-01", "2019-09-01")),
      Deaths     = c(11, 7),
      sex        = "Female",
      bill8      = FALSE
    )
  )

```

Next we are going to merge the datasets to create an all sex version.

```{r merge}

monthly_all <- bind_rows( #combining datasets
  monthly_f %>% mutate(sex = "Female"),
  monthly_m %>% mutate(sex = "Male")
)

monthly_m %>% #checking which months are missing in the female df
  anti_join(monthly_f, by = "month_year") %>%
  select(month_year)

monthly_all <- monthly_all %>%
  group_by(sex) %>% 
  arrange(month_year) %>%
  mutate(time = row_number())
range(monthly_all$time)

monthly_f <- monthly_f %>%
  arrange(month_year) %>%
  mutate(time = row_number())
range(monthly_f$time)

monthly_m <- monthly_m %>%
  arrange(month_year) %>%
  mutate(time = row_number())

range(monthly_m$time)

#looks correct! Saving the datasets

write_csv(monthly_all, "../CleanData/monthly_all.csv")
write_csv(monthly_m, "../CleanData/monthly_m.csv")
write_csv(monthly_f, "../CleanData/monthly_f.csv")
``` 

# All Cause Female Reproductive age 

Next we are going to clean this dataset so we may examine how all-cause deaths may differ from assault only. This will be important as deaths by assault are underreported and often misclassified. Let's start by importing the data and applying the cleaning function for .csv's.

```{r all_cause_female_reproductive_import} 

all_repro_f <- read.csv("../RawData/texas_allcause_female1544.csv")

all_repro_f <- clean.csv(all_repro_f)

head(all_repro_f) 

``` 
Let's check out the data: 
```{r}
ggplot(all_repro_f, aes(month_year, Deaths))+ 
  geom_line()

``` 

Looks good! Let's save the all cause female data to our cleaned folder. 
```{r}
write_csv(all_repro_f, "../CleanData/all_cause_repro_f.csv")
``` 

# Assault all age female 

Next we are going to clean the data for all ages female, cod by assault. 

```{r}
all_age_f_assault <- read_excel("../RawData/All_Ages_Female.xlsx")
all_age_f_assault <- clean.xcel(all_age_f_assault) 
head(all_age_f_assault)
``` 
Same as before, let's briefly check out what the data looks like: 
```{r}
ggplot(all_age_f_assault, aes(month_year, Deaths))+ 
  geom_line()
```  

Let's write our csv: 
```{r}
write_csv(all_age_f_assault, "../CleanData/all_age_f_assault.csv")
```

# Age 15+ 

Let's also check out the data for texas deaths by assault, this time just with ages 15+. 

```{r}
assault_15_plus <- read_excel("../RawData/assault_15_plus.xlsx") 
assault_15_plus <- clean.xcel(assault_15_plus) 
head(assault_15_plus) 

ggplot(assault_15_plus, aes(month_year, Deaths))+ 
  geom_line() 

write_csv(assault_15_plus, "../CleanData/assault_15_plus")
```


# National control set 

This time we are going to pull ages 15-44 deaths by assault nationally. 

```{r}
nat_f_assault <- read_excel("../RawData/national_f_assault.xlsx") 
nat_f_assault <- clean.xcel(nat_f_assault) 
head(nat_f_assault) 

ggplot(nat_f_assault, aes(month_year, Deaths))+ 
  geom_line() 

write_csv(nat_f_assault, "../CleanData/nat_f_assault.csv")
```
